<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fremont Oaks – Monthly Operations & Finances</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f8fafc;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
      gap: 0.75rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .badge {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #0f172a;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .title-main {
      font-size: 1rem;
      font-weight: 600;
    }

    .title-sub {
      font-size: 0.75rem;
      color: #64748b;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .tabs {
      background: #e5e7eb;
      padding: 0.12rem;
      border-radius: 999px;
      display: inline-flex;
      gap: 0.12rem;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 0.25rem 0.9rem;
      font-size: 0.78rem;
      border-radius: 999px;
      cursor: pointer;
      color: #4b5563;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #111827;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .small-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      cursor: pointer;
    }

    .small-btn.active {
      background: #1d4ed8;
      color: white;
      border-color: #1d4ed8;
    }

    .month-label {
      font-size: 0.8rem;
      font-weight: 500;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0f172a;
    }

    main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* Operations layout (map + sidebar) */
    #operationsView {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .map-panel {
      flex: 2;
      min-height: 300px;
      position: relative;
      padding: 0.75rem;
    }

    .map-container {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      background: #000;
    }

    .map-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .map-overlay {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    svg {
      width: 100%;
      height: 100%;
    }

    .area-polygon {
      fill: rgba(20, 184, 166, 0.4);
      stroke: rgb(15, 118, 110);
      stroke-width: 2;
      cursor: pointer;
      pointer-events: auto;
      transition: fill-opacity 0.15s ease, stroke-opacity 0.15s ease;
    }

    .area-polygon.selected {
      fill: rgba(59, 130, 246, 0.5);
      stroke: rgb(37, 99, 235);
    }

    .area-polygon.inactive {
      fill-opacity: 0.12;
      stroke-opacity: 0.25;
    }

    .temp-polygon {
      fill: rgba(239, 68, 68, 0.3);
      stroke: rgb(220, 38, 38);
      stroke-width: 2;
      stroke-dasharray: 4 2;
      pointer-events: none;
    }

    .draw-hint {
      position: absolute;
      left: 0.75rem;
      bottom: 0.75rem;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      max-width: 280px;
    }

    .sidebar {
      flex: 1;
      min-width: 260px;
      max-width: 380px;
      border-left: 1px solid #e2e8f0;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 0.75rem 0.9rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .sidebar-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .sidebar-sub {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 2px;
    }

    .sidebar-body {
      flex: 1;
      padding: 0.75rem 0.9rem;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    .placeholder {
      font-size: 0.8rem;
      color: #64748b;
    }

    .field-label {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 0.15rem 0.4rem;
      margin-top: 0.25rem;
    }

    .status-pill.active {
      background: #dcfce7;
      color: #166534;
    }

    .status-pill.inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .link-messages {
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .link-message {
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      padding: 0.5rem 0.55rem;
    }

    .link-title {
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.2rem;
    }

    .link-url {
      font-size: 0.75rem;
      word-break: break-all;
    }

    .link-url a {
      color: #2563eb;
      text-decoration: none;
    }

    .link-url a:hover {
      text-decoration: underline;
    }

    .sidebar-footer {
      padding: 0.6rem 0.9rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      font-size: 0.78rem;
      padding: 0.3rem 0.6rem;
      border-radius: 0.375rem;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn.primary {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* Finances view */
    #financesView {
      display: none;
      flex: 1;
      padding: 0.75rem 1rem;
    }

    .finances-inner {
      max-width: 800px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      padding: 0.9rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 0;
    }

    .fin-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .fin-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .fin-sub {
      font-size: 0.75rem;
      color: #64748b;
    }

    .fin-current-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .fin-pill {
      padding: 0.3rem 0.6rem;
      border-radius: 0.5rem;
      font-size: 0.78rem;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    .fin-chart {
      width: 100%;
      height: 160px;
      border-radius: 0.75rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
    }

    .fin-chart svg {
      width: 100%;
      height: 100%;
    }

    .fin-table-wrapper {
      max-height: 220px;
      overflow: auto;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th,
    td {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 500;
      color: #4b5563;
      position: sticky;
      top: 0;
    }

    tr.highlight-row {
      background: #eff6ff;
    }

    .fin-placeholder {
      font-size: 0.8rem;
      color: #64748b;
    }

    @media (max-width: 960px) {
      .fin-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }
      #operationsView {
        flex-direction: column;
      }
      .sidebar {
        max-width: none;
        border-left: none;
        border-top: 1px solid #e2e8f0;
      }
    }

    .var-positive {
      color: #15803d; /* green */
    }

    .var-negative {
      color: #b91c1c; /* red */
    }

  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="badge">HOA</div>
      <div>
        <div class="title-main">Fremont Oaks – Monthly Management</div>
        <div class="title-sub">
          Operations map & finances, organized by month.
        </div>
      </div>
    </div>

    <div class="header-center">
      <div class="tabs">
        <button id="tabOperations" class="tab-btn active">Operations</button>
        <button id="tabFinances" class="tab-btn">Finances</button>
      </div>
    </div>

    <div class="header-right">
      <button id="prevMonthBtn" class="small-btn">◀</button>
      <span id="monthLabel" class="month-label">Month</span>
      <button id="nextMonthBtn" class="small-btn">▶</button>
      <button id="toggleDrawBtn" class="small-btn">
        ✏️ Draw: OFF
      </button>
    </div>
  </header>

  <main>
    <!-- OPERATIONS VIEW -->
    <div id="operationsView">
      <section class="map-panel">
        <div id="mapContainer" class="map-container">
          <img id="mapImage" src="map.png" alt="Fremont Oaks top view" />
          <div class="map-overlay">
            <svg
              id="overlaySvg"
              viewBox="0 0 1000 1000"
              preserveAspectRatio="xMidYMid meet"
            ></svg>
          </div>
          <div id="drawHint" class="draw-hint" style="display:none;">
            Draw mode (squares only): click and drag on the map to define a box.
            Release, then click “Finish square” to save it (later download JSON).
          </div>
        </div>
      </section>

      <aside class="sidebar">
        <div class="sidebar-header">
          <div id="sidebarTitle" class="sidebar-title">No area selected</div>
          <div id="sidebarSub" class="sidebar-sub">
            Choose a month above. Click a highlighted box, or draw a new one.
          </div>
        </div>

        <div class="sidebar-body">
          <div id="sidebarContent" class="placeholder">
            Each box has a month range (from/to). For the selected month, active
            boxes are highlighted and inactive boxes fade. Each box can have
            multiple items (files/links), shown as separate messages.
          </div>
        </div>

        <div class="sidebar-footer">
          <button id="finishBtn" class="btn primary" disabled>✅ Finish square</button>
          <button id="cancelBtn" class="btn" disabled>✖ Cancel</button>
          <button id="downloadBtn" class="btn">⬇ Download JSON</button>
        </div>
      </aside>
    </div>

    <!-- FINANCES VIEW -->
    <div id="financesView">
      <div class="finances-inner">
        <div class="fin-header">
          <div>
            <div class="fin-title">Finances</div>
            <div class="fin-sub">
              Month-based operating & reserve statements loaded from
              <code>finances/MM_YYYY_finance.json</code>.
            </div>

          </div>
          <div class="fin-current-row">
            <div id="finMonthLabel" class="fin-pill">Month: –</div>
            <div id="finCurrentNumbers" class="fin-pill">
              Reserves: – • Expenses: –
            </div>
          </div>
        </div>

        <div id="finChart" class="fin-chart">
          <span class="fin-placeholder">No data yet. Add entries in finances.json.</span>
        </div>

        <div class="fin-table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Group</th>
                <th>Account</th>
                <th>Actual</th>
                <th>Budget</th>
                <th>Variance</th>
                <th>Annual Budget</th>
              </tr>
            </thead>
            <tbody id="finTableBody">
              <tr>
                <td colspan="3" class="fin-placeholder">
                  No data.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  
<script>
  // --- Data/state ----------------------------------------------------
  let polygons = []; // operations boxes (areas)
  let selectedId = null;

  let drawMode = false;
  let currentCorners = []; // at most 2 normalized points {x, y} for square
  let isDragging = false;

  const VIEWBOX_SIZE = 1000; // SVG coordinate space
  let selectedMonthId = getCurrentMonthId(); // "YYYY-MM"

  let activeTab = "operations"; // "operations" | "finances"

  // finances: per-month file, cached
  let finances = null;                 // current month finance object
  const financesCache = {};            // monthId -> finance object or null

  // --- DOM refs ------------------------------------------------------
  const overlaySvg = document.getElementById("overlaySvg");
  const mapContainer = document.getElementById("mapContainer");
  const drawHint = document.getElementById("drawHint");

  const sidebarTitle = document.getElementById("sidebarTitle");
  const sidebarSub = document.getElementById("sidebarSub");
  const sidebarContent = document.getElementById("sidebarContent");

  const toggleDrawBtn = document.getElementById("toggleDrawBtn");
  const finishBtn = document.getElementById("finishBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const prevMonthBtn = document.getElementById("prevMonthBtn");
  const nextMonthBtn = document.getElementById("nextMonthBtn");
  const monthLabel = document.getElementById("monthLabel");

  const operationsView = document.getElementById("operationsView");
  const financesView = document.getElementById("financesView");

  const tabOperations = document.getElementById("tabOperations");
  const tabFinances = document.getElementById("tabFinances");

  const finMonthLabel = document.getElementById("finMonthLabel");
  const finCurrentNumbers = document.getElementById("finCurrentNumbers");
  const finChart = document.getElementById("finChart");
  const finTableBody = document.getElementById("finTableBody");

  // --- Month helpers -------------------------------------------------
  function getCurrentMonthId() {
    const d = new Date();
    return (
      d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0")
    );
  }

  function monthIdToIndex(m) {
    if (!m || typeof m !== "string" || !m.includes("-")) return null;
    const [yStr, mmStr] = m.split("-");
    const y = parseInt(yStr, 10);
    const mm = parseInt(mmStr, 10);
    if (isNaN(y) || isNaN(mm)) return null;
    return y * 12 + (mm - 1);
  }

  function isMonthInRange(selected, from, to) {
    const selIdx = monthIdToIndex(selected);
    if (selIdx === null) return true;

    const fromIdx = monthIdToIndex(from);
    const toIdx = monthIdToIndex(to);

    if (fromIdx !== null && selIdx < fromIdx) return false;
    if (toIdx !== null && selIdx > toIdx) return false;
    return true;
  }

  function shiftMonthId(monthId, delta) {
    const idx = monthIdToIndex(monthId);
    if (idx === null) return monthId;
    const newIdx = idx + delta;
    const y = Math.floor(newIdx / 12);
    const m = newIdx % 12;
    return y + "-" + String(m + 1).padStart(2, "0");
  }

  function formatMonthLabel(monthId) {
    const idx = monthIdToIndex(monthId);
    if (idx === null) return monthId || "";
    const y = Math.floor(idx / 12);
    const m = (idx % 12) + 1;
    const d = new Date(y, m - 1, 1);
    return d.toLocaleString(undefined, {
      month: "short",
      year: "numeric",
    });
  }

  // --- Load polygons -------------------------------------------------
  async function loadPolygons() {
    try {
      const res = await fetch("polygons.json", { cache: "no-cache" });
      if (res.ok) {
        polygons = await res.json();
      } else {
        polygons = [];
      }
    } catch (err) {
      console.error("Error loading polygons.json:", err);
      polygons = [];
    }
    renderPolygons();
    updateSidebar();
    updateMonthLabel();
  }

  // --- Load finances for a specific month ----------------------------
  async function loadFinancesForMonth(monthId) {
    // cache hit?
    if (financesCache[monthId] !== undefined) {
      finances = financesCache[monthId];
      renderFinances();
      return;
    }

    const [year, mm] = monthId.split("-");
    const fileName = `${mm}_${year}_finance.json`; // e.g. 11_2025_finance.json
    const url = `finances/${fileName}`;

    try {
      const res = await fetch(url, { cache: "no-cache" });
      if (res.ok) {
        const data = await res.json();
        financesCache[monthId] = data;
      } else {
        console.warn("No finances file for", monthId, "status:", res.status);
        financesCache[monthId] = null;
      }
    } catch (err) {
      console.error("Error loading", url, err);
      financesCache[monthId] = null;
    }

    finances = financesCache[monthId];
    renderFinances();
  }

  // --- Coordinate helpers -------------------------------------------
  function getNormalizedCoordsFromXY(clientX, clientY) {
    const rect = overlaySvg.getBoundingClientRect();
    const x = (clientX - rect.left) / rect.width;
    const y = (clientY - rect.top) / rect.height;
    return {
      x: Math.min(Math.max(x, 0), 1),
      y: Math.min(Math.max(y, 0), 1),
    };
  }

  function getSquareFromCorners(c1, c2) {
    const x1 = Math.min(c1.x, c2.x);
    const x2 = Math.max(c1.x, c2.x);
    const y1 = Math.min(c1.y, c2.y);
    const y2 = Math.max(c1.y, c2.y);
    return [
      { x: x1, y: y1 },
      { x: x2, y: y1 },
      { x: x2, y: y2 },
      { x: x1, y: y2 },
    ];
  }

  function pointsToSvg(points) {
    return points
      .map((p) => `${p.x * VIEWBOX_SIZE},${p.y * VIEWBOX_SIZE}`)
      .join(" ");
  }

  // --- Rendering: operations ----------------------------------------
  function renderPolygons() {
    overlaySvg.innerHTML = "";

    polygons.forEach((poly) => {
      const pts = poly.polygon || [];
      const elem = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "polygon"
      );
      elem.setAttribute("points", pointsToSvg(pts));

      const active = isMonthInRange(
        selectedMonthId,
        poly.from_month,
        poly.to_month
      );
      let cls = "area-polygon";
      if (!active) cls += " inactive";
      if (poly.id === selectedId) cls += " selected";
      elem.setAttribute("class", cls);

      elem.addEventListener("click", (evt) => {
        evt.stopPropagation();
        if (drawMode) return;
        selectedId = poly.id;
        updateSidebar();
        renderPolygons();
      });

      overlaySvg.appendChild(elem);
    });

    // temp square while dragging
    if (drawMode && currentCorners.length === 2) {
      const squarePoints = getSquareFromCorners(
        currentCorners[0],
        currentCorners[1]
      );
      const temp = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "polygon"
      );
      temp.setAttribute("points", pointsToSvg(squarePoints));
      temp.setAttribute("class", "temp-polygon");
      overlaySvg.appendChild(temp);
    }
  }

  function updateMonthLabel() {
    monthLabel.textContent = formatMonthLabel(selectedMonthId);
    if (finMonthLabel) {
      finMonthLabel.textContent =
        "Month: " + formatMonthLabel(selectedMonthId);
    }
  }

  function updateSidebar() {
    const monthText = formatMonthLabel(selectedMonthId);

    if (!selectedId) {
      sidebarTitle.textContent = "No area selected";
      sidebarSub.textContent =
        "Viewing: " +
        monthText +
        ". Click a highlighted box to see its items, or draw a new one.";
      sidebarContent.className = "placeholder";
      sidebarContent.innerHTML =
        "Each box has a from/to month (e.g. 2025-01 to 2025-03). " +
        "For the selected month, active boxes are highlighted and inactive ones fade. " +
        "Each box can have multiple links/files, shown as separate messages.";
      return;
    }

    const poly = polygons.find((p) => p.id === selectedId);
    if (!poly) {
      selectedId = null;
      updateSidebar();
      return;
    }

    const active = isMonthInRange(
      selectedMonthId,
      poly.from_month,
      poly.to_month
    );
    const fromLabel = poly.from_month
      ? formatMonthLabel(poly.from_month)
      : "N/A";
    const toLabel = poly.to_month ? formatMonthLabel(poly.to_month) : "N/A";

    sidebarTitle.textContent = poly.name || "(Unnamed area)";
    sidebarSub.textContent = "Active range: " + fromLabel + " → " + toLabel;

    const wrapper = document.createElement("div");

    const status = document.createElement("div");
    status.className = "status-pill " + (active ? "active" : "inactive");
    status.textContent = active
      ? "Active this month (" + monthText + ")"
      : "Not active in " +
        monthText +
        " (active from " +
        fromLabel +
        " → " +
        toLabel +
        ")";
    wrapper.appendChild(status);

    const links = poly.links || [];
    if (links.length > 0) {
      const label = document.createElement("div");
      label.className = "field-label";
      label.textContent = "Items for this box:";
      wrapper.appendChild(label);

      const list = document.createElement("div");
      list.className = "link-messages";

      links.forEach((link) => {
        const card = document.createElement("div");
        card.className = "link-message";

        const title = document.createElement("div");
        title.className = "link-title";
        title.textContent = link.label || "Item";

        const urlDiv = document.createElement("div");
        urlDiv.className = "link-url";

        const a = document.createElement("a");
        a.href = link.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = link.url;

        urlDiv.appendChild(a);
        card.appendChild(title);
        card.appendChild(urlDiv);
        list.appendChild(card);
      });

      wrapper.appendChild(list);
    } else {
      const noLinks = document.createElement("div");
      noLinks.className = "field-label";
      noLinks.textContent =
        "No links/files added yet. Edit polygons.json to add multiple items.";
      wrapper.appendChild(noLinks);
    }

    sidebarContent.className = "";
    sidebarContent.innerHTML = "";
    sidebarContent.appendChild(wrapper);
  }

  // --- Draw mode (squares, drag-to-see, auto-prompt) ------------------
  function setDrawMode(on) {
    drawMode = on;
    currentCorners = [];
    isDragging = false;
    selectedId = null;
    renderPolygons();
    updateSidebar();

    if (drawMode) {
      toggleDrawBtn.classList.add("active");
      toggleDrawBtn.textContent = "✏️ Draw: ON";
      drawHint.style.display = "block";
      finishBtn.disabled = true;
      cancelBtn.disabled = true;
    } else {
      toggleDrawBtn.classList.remove("active");
      toggleDrawBtn.textContent = "✏️ Draw: OFF";
      drawHint.style.display = "none";
      finishBtn.disabled = true;
      cancelBtn.disabled = true;
    }
  }

  // --- Mouse drawing (desktop) ---------------------------------------
  function handleMouseDown(evt) {
    if (!drawMode) return;
    evt.preventDefault();            // stop image drag
    isDragging = true;
    const norm = getNormalizedCoordsFromXY(evt.clientX, evt.clientY);
    currentCorners = [norm, norm];
    renderPolygons();
  }

  function handleMouseMove(evt) {
    if (!drawMode || !isDragging || currentCorners.length === 0) return;
    evt.preventDefault();
    const norm = getNormalizedCoordsFromXY(evt.clientX, evt.clientY);
    currentCorners[1] = norm;
    renderPolygons();
  }

  function handleMouseUp(evt) {
    if (!drawMode || !isDragging) return;
    evt.preventDefault();
    isDragging = false;
    const norm = getNormalizedCoordsFromXY(evt.clientX, evt.clientY);
    if (currentCorners.length === 1) {
      currentCorners[1] = norm;
    } else {
      currentCorners[1] = norm;
    }
    finalizeBoxIfBigEnough();
  }

  function handleMouseLeave() {
    if (!drawMode) return;
    isDragging = false;
  }

  // --- Touch drawing (mobile) ----------------------------------------
  function handleTouchStart(evt) {
    if (!drawMode) return;
    if (evt.touches.length === 0) return;
    evt.preventDefault();
    const t = evt.touches[0];
    isDragging = true;
    const norm = getNormalizedCoordsFromXY(t.clientX, t.clientY);
    currentCorners = [norm, norm];
    renderPolygons();
  }

  function handleTouchMove(evt) {
    if (!drawMode || !isDragging || currentCorners.length === 0) return;
    if (evt.touches.length === 0) return;
    evt.preventDefault();
    const t = evt.touches[0];
    const norm = getNormalizedCoordsFromXY(t.clientX, t.clientY);
    currentCorners[1] = norm;
    renderPolygons();
  }

  function handleTouchEnd(evt) {
    if (!drawMode || !isDragging) return;
    evt.preventDefault();
    isDragging = false;

    const t =
      evt.changedTouches && evt.changedTouches[0]
        ? evt.changedTouches[0]
        : null;
    if (t) {
      const norm = getNormalizedCoordsFromXY(t.clientX, t.clientY);
      if (currentCorners.length === 1) {
        currentCorners[1] = norm;
      } else {
        currentCorners[1] = norm;
      }
    }

    finalizeBoxIfBigEnough();
  }

  function handleTouchCancel() {
    if (!drawMode) return;
    isDragging = false;
  }

  // --- Common: finalize drawn box ------------------------------------
  function finalizeBoxIfBigEnough() {
    if (currentCorners.length < 2) {
      currentCorners = [];
      renderPolygons();
      return;
    }

    const dx = Math.abs(currentCorners[1].x - currentCorners[0].x);
    const dy = Math.abs(currentCorners[1].y - currentCorners[0].y);
    if (dx < 0.005 || dy < 0.005) {
      // too tiny, treat as accidental tap
      currentCorners = [];
      renderPolygons();
      return;
    }

    renderPolygons();
    commitSquareFromCorners();
  }

  function commitSquareFromCorners() {
    if (currentCorners.length < 2) return;

    const squarePoints = getSquareFromCorners(
      currentCorners[0],
      currentCorners[1]
    );

    const name = prompt("Name for this area (box):", "New area");
    if (name === null) {
      currentCorners = [];
      renderPolygons();
      return;
    }

    const fromDefault = selectedMonthId;
    const toDefault = selectedMonthId;
    const fromMonth = prompt(
      'From month (YYYY-MM), e.g. "2025-01":',
      fromDefault
    );
    if (fromMonth === null) {
      currentCorners = [];
      renderPolygons();
      return;
    }

    const toMonth = prompt(
      'To month (YYYY-MM), e.g. "2025-03":',
      toDefault
    );
    if (toMonth === null) {
      currentCorners = [];
      renderPolygons();
      return;
    }

    const linkUrl = prompt("Optional: first link URL (PDF/photo):", "");
    let links = [];
    if (linkUrl && linkUrl.trim()) {
      const label = prompt(
        'Link label (e.g. "Roof report Jan 2025"):',
        "Item"
      );
      links.push({
        label: label || "Item",
        url: linkUrl.trim(),
      });
    }

    const id = "box-" + Date.now();
    const newPoly = {
      id,
      name: name || "(Unnamed area)",
      from_month: fromMonth || null,
      to_month: toMonth || null,
      links,
      polygon: squarePoints,
    };

    polygons.push(newPoly);
    currentCorners = [];
    selectedId = id;
    renderPolygons();
    updateSidebar();

    alert(
      "Box added in memory. Use 'Download JSON' to save polygons.json and commit it to GitHub."
    );
  }

  function cancelDrawing() {
    if (!drawMode) return;
    currentCorners = [];
    isDragging = false;
    renderPolygons();
    updateSidebar();
  }

  // --- Download JSON --------------------------------------------------
  function downloadJson() {
    const blob = new Blob([JSON.stringify(polygons, null, 2)], {
      type: "application/json",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "polygons.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // --- Finances rendering --------------------------------------------
  function renderFinances() {
    finChart.innerHTML = "";
    finTableBody.innerHTML = "";

    if (!finances) {
      finCurrentNumbers.textContent =
        "No finance file for this month.";
      const span = document.createElement("span");
      span.className = "fin-placeholder";
      span.textContent =
        "Place a file like finances/MM_YYYY_finance.json for this month.";
      finChart.appendChild(span);
      return;
    }

    const opNet = finances.operating?.totals?.net_income || null;
    const resNet = finances.reserve?.totals?.net_reserve || null;

    // summary pill: net operating & net reserve with variance colored
    const opVar = opNet ? opNet.variance : 0;
    const resVar = resNet ? resNet.variance : 0;

    const opVarSpan = document.createElement("span");
    opVarSpan.textContent =
      "Op net: " + (opNet ? formatCurrency(opNet.actual) : "–") +
      " (var " + (opNet ? formatSignedCurrency(opNet.variance) : "–") + ")";
    if (opNet && opNet.variance > 0) opVarSpan.className = "var-positive";
    else if (opNet && opNet.variance < 0) opVarSpan.className = "var-negative";

    const resVarSpan = document.createElement("span");
    resVarSpan.textContent =
      " • Res net: " + (resNet ? formatCurrency(resNet.actual) : "–") +
      " (var " + (resNet ? formatSignedCurrency(resNet.variance) : "–") + ")";
    if (resNet && resNet.variance > 0) resVarSpan.className = "var-positive";
    else if (resNet && resNet.variance < 0) resVarSpan.className = "var-negative";

    finCurrentNumbers.innerHTML = "";
    finCurrentNumbers.appendChild(opVarSpan);
    finCurrentNumbers.appendChild(resVarSpan);

    // chart: Op net vs budget, Res net vs budget
    const values = [];
    if (opNet) {
      values.push(
        { label: "Op Net", value: opNet.actual },
        { label: "Op Bud", value: opNet.budget }
      );
    }
    if (resNet) {
      values.push(
        { label: "Res Net", value: resNet.actual },
        { label: "Res Bud", value: resNet.budget }
      );
    }

    if (values.length > 0) {
      const maxVal = Math.max(
        ...values.map((v) => Math.abs(v.value)),
        1
      );
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", "0 0 100 100");

      values.forEach((cat, idx) => {
        const barWidth = 14;
        const gap = 4;
        const x = 10 + idx * (barWidth + gap);
        const height = (Math.abs(cat.value) / maxVal) * 60;
        const y = 80 - height;

        const rect = document.createElementNS(svgNS, "rect");
        rect.setAttribute("x", String(x));
        rect.setAttribute("y", String(y));
        rect.setAttribute("width", String(barWidth));
        rect.setAttribute("height", String(height));
        rect.setAttribute(
          "fill",
          idx % 2 === 0 ? "#60a5fa" : "#9ca3af"
        );
        svg.appendChild(rect);

        const label = document.createElementNS(svgNS, "text");
        label.setAttribute("x", String(x + barWidth / 2));
        label.setAttribute("y", "90");
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("font-size", "5");
        label.textContent = cat.label;
        svg.appendChild(label);
      });

      finChart.appendChild(svg);
    } else {
      const span = document.createElement("span");
      span.className = "fin-placeholder";
      span.textContent = "No summary data for this month.";
      finChart.appendChild(span);
    }

    // table: all sections/accounts with variance colored
    renderFinanceSections();
  }

  function humanizeKey(key) {
    return key
      .replace(/_/g, " ")
      .replace(/\b\w/g, (c) => c.toUpperCase());
  }

  function addFinanceRow(group, label, data, isTotal = false) {
    if (!data) return;
    const tr = document.createElement("tr");
    if (isTotal) {
      tr.style.fontWeight = "600";
      tr.style.background = "#f9fafb";
    }

    const tdGroup = document.createElement("td");
    tdGroup.textContent = group;
    tr.appendChild(tdGroup);

    const tdLabel = document.createElement("td");
    tdLabel.textContent = label;
    tr.appendChild(tdLabel);

    const tdActual = document.createElement("td");
    tdActual.textContent = formatCurrency(data.actual);
    tr.appendChild(tdActual);

    const tdBudget = document.createElement("td");
    tdBudget.textContent = formatCurrency(data.budget);
    tr.appendChild(tdBudget);

    const tdVar = document.createElement("td");
    const span = document.createElement("span");
    span.textContent = formatSignedCurrency(data.variance);
    if (data.variance > 0) span.className = "var-positive";
    else if (data.variance < 0) span.className = "var-negative";
    tdVar.appendChild(span);
    tr.appendChild(tdVar);

    const tdAnn = document.createElement("td");
    if (typeof data.annual_budget === "number") {
      tdAnn.textContent = formatCurrency(data.annual_budget);
    } else {
      tdAnn.textContent = "–";
    }
    tr.appendChild(tdAnn);

    finTableBody.appendChild(tr);
  }

  function renderFinanceSections() {
    if (!finances) return;

    // OPERATING sections
    const op = finances.operating || {};
    Object.keys(op).forEach((key) => {
      if (key === "totals") return;
      const section = op[key];
      if (!section || !Array.isArray(section.accounts)) return;

      section.accounts.forEach((acc) => {
        addFinanceRow(
          "Operating – " + humanizeKey(key),
          `${acc.code} ${acc.description}`,
          acc,
          false
        );
      });

      if (section.totals) {
        Object.entries(section.totals).forEach(([tKey, tVal]) => {
          addFinanceRow(
            "Operating – " + humanizeKey(key),
            humanizeKey(tKey),
            tVal,
            true
          );
        });
      }
    });

    if (op.totals) {
      Object.entries(op.totals).forEach(([tKey, tVal]) => {
        addFinanceRow("Operating Totals", humanizeKey(tKey), tVal, true);
      });
    }

    // RESERVE sections
    const rv = finances.reserve || {};

    const income = rv.income || {};
    if (Array.isArray(income.accounts)) {
      income.accounts.forEach((acc) => {
        addFinanceRow(
          "Reserve – Income",
          `${acc.code} ${acc.description}`,
          acc,
          false
        );
      });
    }
    if (income.totals) {
      Object.entries(income.totals).forEach(([tKey, tVal]) => {
        addFinanceRow(
          "Reserve – Income",
          humanizeKey(tKey),
          tVal,
          true
        );
      });
    }

    const exp = rv.expenses || {};
    if (Array.isArray(exp.accounts)) {
      exp.accounts.forEach((acc) => {
        addFinanceRow(
          "Reserve – Expense",
          `${acc.code} ${acc.description}`,
          acc,
          false
        );
      });
    }
    if (exp.totals) {
      Object.entries(exp.totals).forEach(([tKey, tVal]) => {
        addFinanceRow(
          "Reserve – Expense",
          humanizeKey(tKey),
          tVal,
          true
        );
      });
    }

    if (rv.totals) {
      Object.entries(rv.totals).forEach(([tKey, tVal]) => {
        addFinanceRow("Reserve Totals", humanizeKey(tKey), tVal, true);
      });
    }
  }

  function formatCurrency(x) {
    if (typeof x !== "number") return "–";
    return x.toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 2,
    });
  }

  function formatSignedCurrency(x) {
    if (typeof x !== "number") return "–";
    const abs = Math.abs(x).toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 2,
    });
    if (x > 0) return "+" + abs;
    if (x < 0) return "-" + abs;
    return abs;
  }

  // --- Tabs ----------------------------------------------------------
  function setActiveTab(tab) {
    activeTab = tab;
    if (tab === "operations") {
      operationsView.style.display = "flex";
      financesView.style.display = "none";
      tabOperations.classList.add("active");
      tabFinances.classList.remove("active");
      toggleDrawBtn.style.display = "inline-flex";
    } else {
      operationsView.style.display = "none";
      financesView.style.display = "flex";
      tabOperations.classList.remove("active");
      tabFinances.classList.add("active");
      toggleDrawBtn.style.display = "none";
      // ensure finances for this month are loaded
      loadFinancesForMonth(selectedMonthId);
    }
    updateMonthLabel();
    renderPolygons();
    updateSidebar();
  }

  // --- Month navigation ----------------------------------------------
  function setSelectedMonth(monthId) {
    selectedMonthId = monthId;
    updateMonthLabel();
    renderPolygons();
    updateSidebar();
    loadFinancesForMonth(selectedMonthId);
  }

  // --- Event wiring --------------------------------------------------
  document.addEventListener("DOMContentLoaded", () => {
    loadPolygons();
    loadFinancesForMonth(selectedMonthId);

    toggleDrawBtn.addEventListener("click", () => {
      setDrawMode(!drawMode);
    });

    // prevent image drag interfering with mouse events
    mapContainer.addEventListener("dragstart", (e) => e.preventDefault());

    // Mouse events
    mapContainer.addEventListener("mousedown", handleMouseDown);
    mapContainer.addEventListener("mousemove", handleMouseMove);
    mapContainer.addEventListener("mouseup", handleMouseUp);
    mapContainer.addEventListener("mouseleave", handleMouseLeave);

    // Touch events (mobile)
    mapContainer.addEventListener("touchstart", handleTouchStart, {
      passive: false,
    });
    mapContainer.addEventListener("touchmove", handleTouchMove, {
      passive: false,
    });
    mapContainer.addEventListener("touchend", handleTouchEnd, {
      passive: false,
    });
    mapContainer.addEventListener("touchcancel", handleTouchCancel, {
      passive: false,
    });

    // Finish / Cancel buttons unused for now
    finishBtn.disabled = true;
    cancelBtn.disabled = true;

    downloadBtn.addEventListener("click", () => {
      if (!polygons || polygons.length === 0) {
        const proceed = confirm(
          "No polygons loaded yet. Download an empty polygons.json file?"
        );
        if (!proceed) return;
      }
      downloadJson();
    });

    prevMonthBtn.addEventListener("click", () => {
      setSelectedMonth(shiftMonthId(selectedMonthId, -1));
    });

    nextMonthBtn.addEventListener("click", () => {
      setSelectedMonth(shiftMonthId(selectedMonthId, 1));
    });

    tabOperations.addEventListener("click", () => {
      setActiveTab("operations");
    });

    tabFinances.addEventListener("click", () => {
      setActiveTab("finances");
    });

    updateMonthLabel();
    setActiveTab("operations");
  });
</script>

</body>
</html>
